<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Payouts Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .step {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .step h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-wrapper:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .file-input-wrapper.loaded {
            border-color: #10b981;
            border-style: solid;
            background: #ecfdf5;
        }
        
        .file-input-wrapper label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
        }
        
        .file-status {
            font-size: 13px;
            color: #10b981;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input, .form-group select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .results.show {
            display: block;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: border-left-color 0.3s;
        }

        .card.highlight {
            border-left-color: #f97316; /* Orange for comparison/Q-independent metrics */
        }
        
        .card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card .value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }
        
        .table-wrapper {
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .progress {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Teacher Payouts Calculator</h1>
            <p>Enrollment-Based Revenue Distribution Tool | Q1-Q4 2025 | Asia/Amman Timezone</p>
        </div>
        
        <div class="content">
            <div class="step">
                <h2>Step 1: Upload Data Files</h2>
                <div class="file-upload">
                    <div class="file-input-wrapper" id="salesWrapper">
                        <label for="salesFile">ðŸ“„ Sales Orders (CSV/Excel)</label>
                        <span class="file-status" id="salesStatus"></span>
                        <input type="file" id="salesFile" accept=".csv,.xlsx,.xls">
                    </div>
                    
                    <div class="file-input-wrapper" id="enrollmentsWrapper">
                        <label for="enrollmentsFile">ðŸ“š Enrollment Progress (CSV/Excel)</label>
                        <span class="file-status" id="enrollmentsStatus"></span>
                        <input type="file" id="enrollmentsFile" accept=".csv,.xlsx,.xls">
                    </div>
                    
                    <div class="file-input-wrapper" id="coursesWrapper">
                        <label for="coursesFile">ðŸŽ“ Courses Mapping (Optional)</label>
                        <span class="file-status" id="coursesStatus"></span>
                        <input type="file" id="coursesFile" accept=".csv,.xlsx,.xls">
                    </div>

                    <div class="file-input-wrapper" id="progressThresholdsWrapper">
                        <label for="progressThresholdsFile">ðŸŽ¯ Course Progress Thresholds (Optional)</label>
                        <span class="file-status" id="progressThresholdsStatus"></span>
                        <input type="file" id="progressThresholdsFile" accept=".csv,.xlsx,.xls">
                    </div>
                    </div>
            </div>
            
            <div class="step">
                <h2>Step 2: Configure Settings</h2>
                <div class="settings-grid">
                    <div class="form-group">
                        <label>Quarter</label>
                        <select id="quarter">
                            <option value="1">Q1 (Jan-Mar)</option>
                            <option value="2">Q2 (Apr-Jun)</option>
                            <option value="3">Q3 (Jul-Sep)</option>
                            <option value="4">Q4 (Oct-Dec)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Year</label>
                        <input type="number" id="year" value="2025" min="2020" max="2030">
                    </div>
                    
                    <div class="form-group">
                        <label>Min Progress % (Default)</label>
                        <input type="number" id="minProgress" value="10" min="0" max="100" step="0.1" title="Used if no specific threshold is provided in the uploaded file.">
                    </div>
                    
                    <div class="form-group">
                        <label>Min Classes Watched</label>
                        <input type="number" id="minClasses" value="10" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Admission Fee ($)</label>
                        <input type="number" id="admissionFee" value="10" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>Discount Threshold %</label>
                        <input type="number" id="discountThreshold" value="30" min="0" max="100">
                    </div>
                    
                    <div class="form-group">
                        <label>Revenue Base</label>
                        <select id="revenueBase">
                            <option value="total">Total (with tax)</option>
                            <option value="subtotal">Subtotal (exclude tax)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Teacher Pool %</label>
                        <input type="number" id="poolPercent" value="40" min="0" max="100">
                    </div>
                </div>
                <div style="margin-top: 15px; font-size: 14px; color: #555;">
                    **Fixed Capping Rule:** The maximum eligible amount per order is **$19.00**.
                </div>
            </div>
            
            <div class="step">
                <h2>Step 3: Calculate</h2>
                <button class="btn btn-primary" id="calculateBtn" disabled>
                    ðŸ§® Calculate Teacher Payouts
                </button>
                <div id="progressContainer" class="hidden">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="status info" id="statusText"></div>
                </div>
            </div>
            
            <div class="results" id="results">
                <div class="step">
                    <h2>ðŸ’° Results</h2>
                    
                    <div class="summary-cards" id="summaryCards"></div>
                    
                    <div class="table-wrapper">
                        <h3 style="padding: 20px 20px 10px;">Orders by Course</h3>
                        <table id="resultsTable"></table>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn btn-success" id="exportTeacherCSV">ðŸ“¥ Teacher Summary CSV</button>
                        <button class="btn btn-success" id="exportCourseCSV">ðŸ“¥ Course Detail CSV</button>
                        <button class="btn btn-success" id="exportAuditCSV">ðŸ“¥ Student Audit CSV</button>
                        <button class="btn btn-success" id="exportPreEligibilityCSV">ðŸ“¥ Orders (Capped, Pre-Eligibility) CSV</button>
                        <button class="btn btn-success" id="exportExcel">ðŸ“Š Export All (Excel)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let appState = {
            salesData: null,
            enrollmentsData: null,
            coursesData: null,
            progressThresholdsData: null, 
            results: null
        };

        document.getElementById('salesFile').addEventListener('change', function(e) {
            loadFile(e, 'sales');
        });
        
        document.getElementById('enrollmentsFile').addEventListener('change', function(e) {
            loadFile(e, 'enrollments');
        });
        
        document.getElementById('coursesFile').addEventListener('change', function(e) {
            loadFile(e, 'courses');
        });

        document.getElementById('progressThresholdsFile').addEventListener('change', function(e) {
            loadFile(e, 'progressThresholds');
        });
        
        document.getElementById('calculateBtn').addEventListener('click', calculatePayouts);
        document.getElementById('exportTeacherCSV').addEventListener('click', function() { exportCSV('teacher'); });
        document.getElementById('exportCourseCSV').addEventListener('click', function() { exportCSV('course'); });
        document.getElementById('exportAuditCSV').addEventListener('click', function() { exportCSV('audit'); });
        document.getElementById('exportPreEligibilityCSV').addEventListener('click', function() { exportCSV('pre-eligibility'); }); // ðŸ†• NEW LISTENER
        document.getElementById('exportExcel').addEventListener('click', exportExcel);

        function loadFile(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const ext = file.name.split('.').pop().toLowerCase();

            reader.onload = function(e) {
                try {
                    let data;
                    if (ext === 'csv') {
                        const result = Papa.parse(e.target.result, { header: true, skipEmptyLines: true });
                        data = result.data;
                    } else {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        data = XLSX.utils.sheet_to_json(firstSheet);
                    }

                    appState[type + 'Data'] = data;
                    document.getElementById(type + 'Status').textContent = 'âœ“ ' + data.length + ' rows';
                    document.getElementById(type + 'Wrapper').classList.add('loaded');
                    
                    checkReady();
                } catch (error) {
                    alert('Error loading file: ' + error.message);
                }
            };

            if (ext === 'csv') {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function checkReady() {
            const ready = appState.salesData && appState.enrollmentsData;
            document.getElementById('calculateBtn').disabled = !ready;
        }

        function normalizeEmail(email) {
            if (!email) return '';
            return String(email).trim().toLowerCase();
        }

        function getQuarter(month) {
            return Math.floor((month - 1) / 3) + 1;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function updateProgress(percent, message) {
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('statusText').textContent = message;
        }

        function calculatePayouts() {
            updateProgress(10, 'ðŸ”„ Starting calculation...');
            
            setTimeout(function() {
                try {
                    const settings = {
                        quarter: parseInt(document.getElementById('quarter').value),
                        year: parseInt(document.getElementById('year').value),
                        minProgressDefault: parseFloat(document.getElementById('minProgress').value),
                        minClasses: parseInt(document.getElementById('minClasses').value),
                        admissionFee: parseFloat(document.getElementById('admissionFee').value),
                        discountThreshold: parseFloat(document.getElementById('discountThreshold').value),
                        revenueBase: document.getElementById('revenueBase').value,
                        poolPercent: parseFloat(document.getElementById('poolPercent').value) / 100,
                        maxEligibleAmount: 19.00 // Fixed cap as per user request
                    };

                    updateProgress(30, 'ðŸ”„ Processing sales...');
                    
                    const sales = appState.salesData.map(function(order) {
                        return {
                            id: order.id,
                            email: normalizeEmail(order.user_email),
                            timestamp: parseDate(order.timestamp),
                            total: parseFloat(order.total) || 0,
                            subtotal: parseFloat(order.subtotal) || 0,
                            status: String(order.status || '').toLowerCase(),
                            subId: order.subscription_transaction_id
                        };
                    }).filter(function(o) {
                        return o.timestamp && o.total > 0 && 
                               ['completed', 'paid', 'success', 'succeeded'].indexOf(o.status) >= 0;
                    });

                    sales.forEach(function(o) {
                        o.month = o.timestamp.getMonth() + 1;
                        o.year = o.timestamp.getFullYear();
                        o.quarter = getQuarter(o.month);
                    });

                    // 1. Calculate Gross Sales Revenue (Post Status Filter - All Time)
                    let grossSalesRevenue = 0;
                    const totalSalesOrders = sales.length;
                    sales.forEach(function(o) {
                        grossSalesRevenue += o.total;
                    });
                    
                    // 2. Calculate Sales Revenue after Capping/Admission Fee but before Eligibility Filters (All Time)
                    let salesCappedRevenue = 0;
                    const preEligibilityOrders = []; // ðŸ†• NEW ARRAY: Orders for the selected quarter, Pre-Eligibility
                    
                    const subIds = {}; // Used to identify the first payment of a subscription
                    sales.forEach(function(o) {
                        if (o.subId && !subIds[o.subId]) {
                            subIds[o.subId] = o.timestamp.getTime();
                        }
                    });

                    sales.forEach(function(order) {
                        // Admission Fee / Capping Logic applied to ALL valid sales
                        const isFirstMonth = order.subId && subIds[order.subId] === order.timestamp.getTime();
                        
                        const baseAmount = settings.revenueBase === 'total' ? order.total : order.subtotal;
                        
                        const listPrice = isFirstMonth ? 29.99 : 19.99;
                        const discountPct = Math.max(0, (1 - (order.total / listPrice)) * 100);
                        
                        const includeAdmission = isFirstMonth && discountPct > settings.discountThreshold;
                        const admissionComponent = includeAdmission ? settings.admissionFee : 0;
                        
                        let originalEligibleAmount = baseAmount + admissionComponent;
                        
                        const cappedAmount = Math.min(originalEligibleAmount, settings.maxEligibleAmount); 
                        
                        salesCappedRevenue += cappedAmount; // All-time Capped Revenue
                        
                        // ðŸ†• Store Capped/Admission data into the order object
                        order.originalEligibleAmount = originalEligibleAmount;
                        order.eligibleAmount = cappedAmount;
                        order.isFirstMonth = isFirstMonth;
                        order.includeAdmission = includeAdmission;

                        // ðŸ†• Check for Quarter/Year match to store the data that *can* be exported
                        if (order.quarter === settings.quarter && order.year === settings.year) {
                            preEligibilityOrders.push(order);
                        }
                    });


                    updateProgress(50, 'ðŸ”„ Processing enrollments...');
                    
                    const enrollments = appState.enrollmentsData.map(function(e) {
                        return {
                            email: normalizeEmail(e['User Email'] || e.user_email),
                            course: e['Course Name'] || e.course_name,
                            progress: parseFloat(e['User Progress (%)'] || e.progress || 0),
                            enrollmentDate: parseDate(e['Enrollment Date'] || e.enrollment_date)
                        };
                    });
                    
                    // ... (Course Mapping and Progress Thresholds logic remains the same)

                    const courseMap = {};
                    if (appState.coursesData) {
                        appState.coursesData.forEach(function(c) {
                            const courseName = c.course_name || c['Course Name'];
                            courseMap[courseName] = {
                                teacherId: c.teacher_id,
                                teacherName: c.teacher_name,
                                totalClasses: parseInt(c.total_classes) || 50
                            };
                        });
                    }

                    const progressThresholds = {};
                    if (appState.progressThresholdsData) {
                        appState.progressThresholdsData.forEach(function(t) {
                            const courseName = t.course_name || t['Course Name'];
                            const minProgress = parseFloat(t.min_progress_percentage || t['Minimum progress percentage']);
                            if (courseName && !isNaN(minProgress) && minProgress >= 0 && minProgress <= 100) {
                                progressThresholds[courseName] = minProgress;
                            }
                        });
                    }

                    enrollments.forEach(function(e) {
                        if (!courseMap[e.course]) {
                            const idx = Object.keys(courseMap).length + 1;
                            courseMap[e.course] = {
                                teacherId: 'T' + idx,
                                teacherName: 'Teacher ' + idx,
                                totalClasses: 50
                            };
                        }
                        courseMap[e.course].minProgress = progressThresholds[e.course] !== undefined 
                            ? progressThresholds[e.course]
                            : settings.minProgressDefault;
                    });


                    updateProgress(70, 'ðŸ”„ Calculating eligibility...');
                    
                    const eligibility = [];
                    
                    enrollments.forEach(function(enroll) {
                        const courseInfo = courseMap[enroll.course] || {};
                        const totalClasses = courseInfo.totalClasses || 50;
                        const classesWatched = Math.round((enroll.progress / 100) * totalClasses);
                        
                        const minProgressForCourse = courseInfo.minProgress !== undefined 
                            ? courseInfo.minProgress
                            : settings.minProgressDefault; 
                        
                        const meetsProgress = enroll.progress >= minProgressForCourse;
                        const meetsClasses = classesWatched >= settings.minClasses;
                        const isEligible = meetsProgress && meetsClasses;
                        
                        // **This is the filter that removes most orders based on student consumption**
                        if (!isEligible) return;
                        
                        const studentOrders = sales.filter(function(o) {
                            return o.email === enroll.email && o.timestamp >= enroll.enrollmentDate;
                        }).sort(function(a, b) {
                            return a.timestamp - b.timestamp;
                        });
                        
                        if (studentOrders.length === 0) return;
                        
                        
                        let eligibleCount = 0;
                        
                        studentOrders.forEach(function(order) {
                            if (eligibleCount >= 3) return; // **3-order cap per student per course**
                            
                            // Use the pre-calculated eligible amounts stored in the order object
                            const originalEligibleAmount = order.originalEligibleAmount; 
                            const eligibleAmount = order.eligibleAmount; 

                            eligibility.push({
                                email: enroll.email,
                                course: enroll.course,
                                teacherId: courseInfo.teacherId,
                                teacherName: courseInfo.teacherName,
                                orderId: order.id,
                                month: order.month,
                                year: order.year,
                                quarter: order.quarter,
                                isFirstMonth: order.isFirstMonth,
                                discountPct: Math.max(0, (1 - (order.total / (order.isFirstMonth ? 29.99 : 19.99))) * 100),
                                includeAdmission: order.includeAdmission,
                                originalEligibleAmount: originalEligibleAmount, 
                                eligibleAmount: eligibleAmount 
                            });
                            
                            eligibleCount++;
                        });
                    });

                    updateProgress(90, 'ðŸ”„ Calculating payouts...');
                    
                    const quarterEligible = eligibility.filter(function(e) {
                        return e.quarter === settings.quarter && e.year === settings.year;
                    });
                    
                    let quarterRevenueCapped = 0; 
                    let quarterRevenueOriginal = 0; 
                    let totalOrdersInQuarter = quarterEligible.length;

                    quarterEligible.forEach(function(e) {
                        quarterRevenueCapped += e.eligibleAmount;
                        quarterRevenueOriginal += e.originalEligibleAmount;
                    });
                    
                    const teacherPool = quarterRevenueCapped * settings.poolPercent;
                    
                    const teacherGroups = _.groupBy(quarterEligible, 'teacherId');
                    const teacherPayouts = [];
                    
                    for (const teacherId in teacherGroups) {
                        const orders = teacherGroups[teacherId];
                        const orderCount = orders.length;
                        const shareRatio = orderCount / totalOrdersInQuarter;
                        const payout = teacherPool * shareRatio; 
                        
                        teacherPayouts.push({
                            teacherId: teacherId,
                            teacherName: orders[0].teacherName,
                            orderCount: orderCount,
                            shareRatio: shareRatio,
                            payout: payout
                        });
                    }
                    
                    teacherPayouts.sort(function(a, b) {
                        return b.payout - a.payout;
                    });
                    
                    appState.results = {
                        settings: settings,
                        grossSalesRevenue: grossSalesRevenue, 
                        totalSalesOrders: totalSalesOrders,   
                        salesCappedRevenue: salesCappedRevenue,
                        preEligibilityOrders: preEligibilityOrders, // ðŸ†• NEW FIELD
                        originalQuarterRevenue: quarterRevenueOriginal, 
                        quarterRevenue: quarterRevenueCapped, 
                        teacherPool: teacherPool,
                        totalOrders: totalOrdersInQuarter,
                        teacherPayouts: teacherPayouts,
                        eligibility: quarterEligible,
                        allEligibility: eligibility
                    };
                    
                    updateProgress(100, 'âœ… Complete!');
                    
                    setTimeout(function() {
                        displayResults();
                        document.getElementById('progressContainer').classList.add('hidden');
                    }, 500);
                    
                } catch (error) {
                    alert('Calculation error: ' + error.message);
                    console.error(error);
                    document.getElementById('progressContainer').classList.add('hidden');
                }
            }, 100);
        }

        function displayResults() {
            const r = appState.results;
            
            let summaryHTML = '';
            summaryHTML += '<div class="card"><h3>Quarter</h3><div class="value">Q' + r.settings.quarter + ' ' + r.settings.year + '</div></div>';
            
            // 1. Total Sales (Post Status Filter - Gross Revenue)
            summaryHTML += '<div class="card highlight"><h3>Total Sales (Post Status)</h3><div class="value">$' + r.grossSalesRevenue.toFixed(2) + '</div></div>'; 
            
            // 2. Total Sales (Post Status & Capped - The user\'s requested comparison metric, Now uses highlight)
            summaryHTML += '<div class="card highlight"><h3>Total Sales (Capped, Pre-Eligibility)</h3><div class="value">$' + r.salesCappedRevenue.toFixed(2) + '</div></div>'; 
            
            // 3. Total Eligible Revenue (Original)
            summaryHTML += '<div class="card"><h3>Total Eligible Revenue (Original)</h3><div class="value">$' + r.originalQuarterRevenue.toFixed(2) + '</div></div>'; 
            
            // 4. Total Eligible Revenue (Capped - The distribution base)
            summaryHTML += '<div class="card"><h3>Total Eligible Revenue (Capped)</h3><div class="value">$' + r.quarterRevenue.toFixed(2) + '</div></div>'; 
            
            // 5. Teacher Pool (The final amount for distribution)
            summaryHTML += '<div class="card"><h3>Teacher Pool (' + (r.settings.poolPercent * 100).toFixed(0) + '% Capped)</h3><div class="value">$' + r.teacherPool.toFixed(2) + '</div></div>'; 
            
            // Order Counts
            summaryHTML += '<div class="card highlight"><h3>Total Sales Orders (Post Status)</h3><div class="value">' + r.totalSalesOrders + '</div></div>';

            summaryHTML += '<div class="card"><h3>Total Eligible Orders</h3><div class="value">' + r.totalOrders + '</div></div>';
            
            summaryHTML += '<div class="card"><h3>Teachers</h3><div class="value">' + r.teacherPayouts.length + '</div></div>';
            
            document.getElementById('summaryCards').innerHTML = summaryHTML;
            
            const courseGroups = _.groupBy(r.eligibility, function(e) {
                return e.teacherId + '_' + e.course;
            });
            
            const courseData = [];
            for (const key in courseGroups) {
                const orders = courseGroups[key];
                let revenue = 0;
                orders.forEach(function(o) {
                    revenue += o.eligibleAmount;
                });
                
                courseData.push({
                    teacherId: orders[0].teacherId,
                    teacherName: orders[0].teacherName,
                    course: orders[0].course,
                    orderCount: orders.length,
                    revenue: revenue
                });
            }
            
            courseData.sort(function(a, b) {
                const nameCompare = a.teacherName.localeCompare(b.teacherName);
                if (nameCompare !== 0) return nameCompare;
                return a.course.localeCompare(b.course);
            });
            
            const teacherPayoutMap = {};
            r.teacherPayouts.forEach(function(t) {
                teacherPayoutMap[t.teacherId] = t.payout;
            });
            
            let tableHTML = '<thead><tr>';
            tableHTML += '<th>Teacher</th>';
            tableHTML += '<th>Course</th>';
            tableHTML += '<th>Orders</th>';
            tableHTML += '<th>Course Revenue (Capped)</th>';
            tableHTML += '<th>Teacher Payout (' + (r.settings.poolPercent * 100).toFixed(0) + '% Capped)</th>';
            tableHTML += '</tr></thead><tbody>';
            
            for (let i = 0; i < courseData.length; i++) {
                const c = courseData[i];
                const showPayout = i === 0 || courseData[i-1].teacherId !== c.teacherId;
                const teacherPayout = teacherPayoutMap[c.teacherId] || 0;
                
                tableHTML += '<tr>';
                tableHTML += '<td>' + c.teacherName + '</td>';
                tableHTML += '<td><strong>' + c.course + '</strong></td>';
                tableHTML += '<td>' + c.orderCount + '</td>';
                tableHTML += '<td>$' + c.revenue.toFixed(2) + '</td>';
                tableHTML += '<td>' + (showPayout ? '<strong>$' + teacherPayout.toFixed(2) + '</strong>' : '') + '</td>';
                tableHTML += '</tr>';
            }
            
            tableHTML += '</tbody>';
            
            document.getElementById('resultsTable').innerHTML = tableHTML;
            document.getElementById('results').classList.add('show');
        }

        function exportCSV(type) {
            const r = appState.results;
            let data = [];
            let filename = '';
            
            if (type === 'teacher') {
                r.teacherPayouts.forEach(function(t) {
                    data.push({
                        teacher_id: t.teacherId,
                        teacher_name: t.teacherName,
                        quarter: r.settings.quarter,
                        year: r.settings.year,
                        eligible_orders: t.orderCount,
                        payout_amount: t.payout.toFixed(2)
                    });
                });
                filename = 'teacher_summary_Q' + r.settings.quarter + '_' + r.settings.year + '.csv';
            } else if (type === 'course') {
                const grouped = _.groupBy(r.eligibility, function(e) {
                    return e.teacherId + '_' + e.course + '_' + e.month;
                });
                
                for (const key in grouped) {
                    const group = grouped[key];
                    let revenueCapped = 0;
                    let revenueOriginal = 0;
                    let admCount = 0;
                    group.forEach(function(o) {
                        revenueCapped += o.eligibleAmount;
                        revenueOriginal += o.originalEligibleAmount;
                        if (o.includeAdmission) admCount++;
                    });
                    
                    data.push({
                        teacher_id: group[0].teacherId,
                        teacher_name: group[0].teacherName,
                        course_name: group[0].course,
                        month: group[0].month,
                        year: group[0].year,
                        eligible_orders: group.length,
                        eligible_amount_original: revenueOriginal.toFixed(2), 
                        eligible_amount_capped: revenueCapped.toFixed(2), 
                        admission_included: admCount
                    });
                }
                filename = 'course_detail_Q' + r.settings.quarter + '_' + r.settings.year + '.csv';
            } else if (type === 'audit') {
                const grouped = _.groupBy(r.allEligibility, function(e) {
                    return e.email + '_' + e.course;
                });
                
                for (const key in grouped) {
                    const group = grouped[key];
                    const months = [];
                    const orderIds = [];
                    let firstCount = 0;
                    let admCount = 0;
                    
                    group.forEach(function(o) {
                        months.push(o.month);
                        orderIds.push(o.orderId);
                        if (o.isFirstMonth) firstCount++;
                        if (o.includeAdmission) admCount++;
                    });
                    
                    data.push({
                        user_email: group[0].email,
                        course_name: group[0].course,
                        months_charged: months.join(','),
                        total_charged: group.length,
                        first_months: firstCount,
                        admission_included: admCount,
                        order_ids: orderIds.join(',')
                    });
                }
                filename = 'student_audit_Q' + r.settings.quarter + '_' + r.settings.year + '.csv';
            } else if (type === 'pre-eligibility') { // ðŸ†• NEW EXPORT TYPE
                r.preEligibilityOrders.forEach(function(o) {
                    data.push({
                        order_id: o.id,
                        user_email: o.email,
                        timestamp: o.timestamp.toISOString(),
                        original_total: o.total.toFixed(2),
                        is_first_month: o.isFirstMonth ? 'Yes' : 'No',
                        admission_included: o.includeAdmission ? 'Yes' : 'No',
                        eligible_amount_original: o.originalEligibleAmount.toFixed(2),
                        eligible_amount_capped: o.eligibleAmount.toFixed(2),
                        quarter: o.quarter,
                        year: o.year
                    });
                });
                filename = 'pre_eligibility_orders_Q' + r.settings.quarter + '_' + r.settings.year + '.csv';
            }
            
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportExcel() {
            const r = appState.results;
            
            const teacherData = [];
            r.teacherPayouts.forEach(function(t) {
                teacherData.push({
                    'Teacher ID': t.teacherId,
                    'Teacher Name': t.teacherName,
                    'Quarter': r.settings.quarter,
                    'Year': r.settings.year,
                    'Eligible Orders': t.orderCount,
                    'Payout Amount': t.payout.toFixed(2)
                });
            });
            
            const courseGrouped = _.groupBy(r.eligibility, function(e) {
                return e.teacherId + '_' + e.course + '_' + e.month;
            });
            
            const courseData = [];
            for (const key in courseGrouped) {
                const group = courseGrouped[key];
                let revenueCapped = 0;
                let revenueOriginal = 0;
                let admCount = 0;
                group.forEach(function(o) {
                    revenueCapped += o.eligibleAmount;
                    revenueOriginal += o.originalEligibleAmount;
                    if (o.includeAdmission) admCount++;
                });
                
                courseData.push({
                    'Teacher ID': group[0].teacherId,
                    'Teacher Name': group[0].teacherName,
                    'Course Name': group[0].course,
                    'Month': group[0].month,
                    'Year': group[0].year,
                    'Eligible Orders': group.length,
                    'Eligible Amount (Original)': revenueOriginal.toFixed(2), 
                    'Eligible Amount (Capped)': revenueCapped.toFixed(2), 
                    'Admission Included': admCount
                });
            }
            
            const studentGrouped = _.groupBy(r.allEligibility, function(e) {
                return e.email + '_' + e.course;
            });
            
            const studentData = [];
            for (const key in studentGrouped) {
                const group = studentGrouped[key];
                const months = [];
                const orderIds = [];
                let firstCount = 0;
                let admCount = 0;
                
                group.forEach(function(o) {
                    months.push(o.month);
                    orderIds.push(o.orderId);
                    if (o.isFirstMonth) firstCount++;
                    if (o.includeAdmission) admCount++;
                });
                
                studentData.push({
                    'User Email': group[0].email,
                    'Course Name': group[0].course,
                    'Months Charged': months.join(','),
                    'Total Charged': group.length,
                    'First Months': firstCount,
                    'Admission Included': admCount,
                    'Order IDs': orderIds.join(',')
                });
            }
            
            // ðŸ†• NEW DATA FOR PRE-ELIGIBILITY SHEET
            const preEligibilityData = [];
            r.preEligibilityOrders.forEach(function(o) {
                preEligibilityData.push({
                    'Order ID': o.id,
                    'User Email': o.email,
                    'Timestamp': o.timestamp.toISOString(),
                    'Original Total': o.total.toFixed(2),
                    'Is First Month': o.isFirstMonth ? 'Yes' : 'No',
                    'Admission Included': o.includeAdmission ? 'Yes' : 'No',
                    'Eligible Amount (Original)': o.originalEligibleAmount.toFixed(2),
                    'Eligible Amount (Capped)': o.eligibleAmount.toFixed(2),
                    'Quarter': o.quarter,
                    'Year': o.year
                });
            });
            
            const summaryData = [
                { 'Metric': 'Quarter', 'Value': 'Q' + r.settings.quarter },
                { 'Metric': 'Year', 'Value': r.settings.year },
                // Q-INDEPENDENT METRICS
                { 'Metric': 'Total Sales Revenue (Post Status Filter)', 'Value': `$${r.grossSalesRevenue.toFixed(2)}` },
                { 'Metric': 'Total Sales Revenue (Capped, Pre-Eligibility - All Time)', 'Value': `$${r.salesCappedRevenue.toFixed(2)}` },
                { 'Metric': 'Total Sales Orders (Post Status Filter)', 'Value': r.totalSalesOrders },
                // Q-DEPENDENT METRICS
                { 'Metric': 'Total Eligible Revenue (Original)', 'Value': `$${r.originalQuarterRevenue.toFixed(2)}` },
                { 'Metric': 'Total Eligible Revenue (Capped)', 'Value': `$${r.quarterRevenue.toFixed(2)}` },
                { 'Metric': 'Teacher Pool (' + (r.settings.poolPercent * 100).toFixed(0) + '% Capped)', 'Value': `$${r.teacherPool.toFixed(2)}` },
                { 'Metric': 'Total Eligible Orders (Q' + r.settings.quarter + ')', 'Value': r.totalOrders },
                { 'Metric': 'Teachers', 'Value': r.teacherPayouts.length },
                { 'Metric': 'Generated', 'Value': new Date().toLocaleString() }
            ];
            
            const wb = XLSX.utils.book_new();
            
            const ws1 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Summary');
            
            const ws2 = XLSX.utils.json_to_sheet(teacherData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Teacher Summary');
            
            const ws3 = XLSX.utils.json_to_sheet(courseData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Course Detail');
            
            const ws4 = XLSX.utils.json_to_sheet(studentData);
            XLSX.utils.book_append_sheet(wb, ws4, 'Student Audit');
            
            const ws5 = XLSX.utils.json_to_sheet(preEligibilityData); // ðŸ†• NEW SHEET
            XLSX.utils.book_append_sheet(wb, ws5, 'Pre-Eligibility Orders');

            XLSX.writeFile(wb, 'exports_Q' + r.settings.quarter + '_' + r.settings.year + '.xlsx');
        }
    </script>
</body>
</html>