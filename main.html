<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Payouts Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .step {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .step h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-wrapper:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .file-input-wrapper.loaded {
            border-color: #10b981;
            border-style: solid;
            background: #ecfdf5;
        }
        
        .file-input-wrapper label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
        }
        
        .file-status {
            font-size: 13px;
            color: #10b981;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input, .form-group select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .results.show {
            display: block;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card .value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }
        
        .table-wrapper {
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .progress {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Teacher Payouts Calculator</h1>
            <p>Enrollment-Based Revenue Distribution Tool | Q1-Q4 2025 | Asia/Amman Timezone</p>
        </div>
        
        <div class="content">
            <!-- Step 1: Upload Files -->
            <div class="step">
                <h2>Step 1: Upload Data Files</h2>
                <div class="file-upload">
                    <div class="file-input-wrapper" id="salesWrapper">
                        <label for="salesFile">ðŸ“„ Sales Orders (CSV/Excel)</label>
                        <span class="file-status" id="salesStatus"></span>
                        <input type="file" id="salesFile" accept=".csv,.xlsx,.xls">
                    </div>
                    
                    <div class="file-input-wrapper" id="enrollmentsWrapper">
                        <label for="enrollmentsFile">ðŸ“š Enrollment Progress (CSV/Excel)</label>
                        <span class="file-status" id="enrollmentsStatus"></span>
                        <input type="file" id="enrollmentsFile" accept=".csv,.xlsx,.xls">
                    </div>
                    
                    <div class="file-input-wrapper" id="coursesWrapper">
                        <label for="coursesFile">ðŸŽ“ Courses Mapping (Optional - CSV/Excel)</label>
                        <span class="file-status" id="coursesStatus"></span>
                        <input type="file" id="coursesFile" accept=".csv,.xlsx,.xls">
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Configure Settings -->
            <div class="step">
                <h2>Step 2: Configure Calculation Settings</h2>
                <div class="settings-grid">
                    <div class="form-group">
                        <label>Quarter</label>
                        <select id="quarter">
                            <option value="1">Q1 (Jan-Mar)</option>
                            <option value="2">Q2 (Apr-Jun)</option>
                            <option value="3">Q3 (Jul-Sep)</option>
                            <option value="4">Q4 (Oct-Dec)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Year</label>
                        <input type="number" id="year" value="2025" min="2020" max="2030">
                    </div>
                    
                    <div class="form-group">
                        <label>Min Progress %</label>
                        <input type="number" id="minProgress" value="10" min="0" max="100" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label>Min Classes Watched</label>
                        <input type="number" id="minClasses" value="10" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Admission Fee ($)</label>
                        <input type="number" id="admissionFee" value="10" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>Discount Threshold %</label>
                        <input type="number" id="discountThreshold" value="30" min="0" max="100" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label>Revenue Base</label>
                        <select id="revenueBase">
                            <option value="total">Total (with tax)</option>
                            <option value="subtotal">Subtotal (exclude tax)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Teacher Pool %</label>
                        <input type="number" id="poolPercent" value="40" min="0" max="100" step="1">
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Calculate -->
            <div class="step">
                <h2>Step 3: Calculate Payouts</h2>
                <button class="btn btn-primary" id="calculateBtn" disabled>
                    ðŸ§® Calculate Teacher Payouts
                </button>
                <div id="progressContainer" class="hidden">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="status info" id="statusText"></div>
                </div>
            </div>
            
            <!-- Results -->
            <div class="results" id="results">
                <div class="step">
                    <h2>ðŸ’° Calculation Results</h2>
                    
                    <div class="summary-cards" id="summaryCards"></div>
                    
                    <div class="table-wrapper">
                        <h3 style="padding: 20px 20px 10px;">Teacher Payouts</h3>
                        <table id="resultsTable"></table>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn btn-success" id="exportTeacherCSV">ðŸ“¥ Download Teacher Summary (CSV)</button>
                        <button class="btn btn-success" id="exportCourseCSV">ðŸ“¥ Download Course Detail (CSV)</button>
                        <button class="btn btn-success" id="exportAuditCSV">ðŸ“¥ Download Student Audit (CSV)</button>
                        <button class="btn btn-success" id="exportExcel">ðŸ“Š Download All (Excel)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let state = {
            salesData: null,
            enrollmentsData: null,
            coursesData: null,
            results: null
        };

        // File upload handlers
        document.getElementById('salesFile').addEventListener('change', (e) => loadFile(e, 'sales'));
        document.getElementById('enrollmentsFile').addEventListener('change', (e) => loadFile(e, 'enrollments'));
        document.getElementById('coursesFile').addEventListener('change', (e) => loadFile(e, 'courses'));
        
        // Calculate button
        document.getElementById('calculateBtn').addEventListener('click', calculatePayouts);
        
        // Export buttons
        document.getElementById('exportTeacherCSV').addEventListener('click', () => exportCSV('teacher'));
        document.getElementById('exportCourseCSV').addEventListener('click', () => exportCSV('course'));
        document.getElementById('exportAuditCSV').addEventListener('click', () => exportCSV('audit'));
        document.getElementById('exportExcel').addEventListener('click', exportExcel);

        function loadFile(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const ext = file.name.split('.').pop().toLowerCase();

            reader.onload = (e) => {
                try {
                    let data;
                    if (ext === 'csv') {
                        const result = Papa.parse(e.target.result, { header: true, skipEmptyLines: true });
                        data = result.data;
                    } else {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        data = XLSX.utils.sheet_to_json(firstSheet);
                    }

                    state[type + 'Data'] = data;
                    document.getElementById(type + 'Status').textContent = `âœ“ ${data.length} rows loaded`;
                    document.getElementById(type + 'Wrapper').classList.add('loaded');
                    
                    checkReadyToCalculate();
                } catch (error) {
                    alert(`Error loading ${type} file: ${error.message}`);
                }
            };

            if (ext === 'csv') {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function checkReadyToCalculate() {
            const ready = state.salesData && state.enrollmentsData;
            document.getElementById('calculateBtn').disabled = !ready;
        }

        function normalizeEmail(email) {
            return email ? String(email).trim().toLowerCase() : '';
        }

        function getQuarter(month) {
            return Math.floor((month - 1) / 3) + 1;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function inferClassesWatched(progressPct, totalClasses) {
            if (!progressPct || !totalClasses) return 0;
            return Math.round((progressPct / 100) * totalClasses);
        }

        function computeDiscount(total, isFirstMonth) {
            const listPrice = isFirstMonth ? 29.99 : 19.99;
            const discount = (1 - (total / listPrice)) * 100;
            return Math.max(0, discount);
        }

        function updateProgress(percent, message) {
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('statusText').textContent = message;
        }

        function calculatePayouts() {
            updateProgress(10, 'ðŸ”„ Normalizing data...');
            
            setTimeout(() => {
                try {
                    const settings = {
                        quarter: parseInt(document.getElementById('quarter').value),
                        year: parseInt(document.getElementById('year').value),
                        minProgress: parseFloat(document.getElementById('minProgress').value),
                        minClasses: parseInt(document.getElementById('minClasses').value),
                        admissionFee: parseFloat(document.getElementById('admissionFee').value),
                        discountThreshold: parseFloat(document.getElementById('discountThreshold').value),
                        revenueBase: document.getElementById('revenueBase').value,
                        poolPercent: parseFloat(document.getElementById('poolPercent').value) / 100
                    };

                    updateProgress(30, 'ðŸ”„ Processing sales orders...');
                    
                    // Normalize sales data
                    const sales = state.salesData.map(order => ({
                        ...order,
                        email: normalizeEmail(order.user_email),
                        timestamp: parseDate(order.timestamp),
                        total: parseFloat(order.total) || 0,
                        subtotal: parseFloat(order.subtotal) || 0,
                        status: String(order.status || '').toLowerCase()
                    })).filter(o => 
                        o.timestamp && 
                        o.total > 0 && 
                        ['completed', 'paid', 'success', 'succeeded'].includes(o.status)
                    );

                    sales.forEach(o => {
                        o.month = o.timestamp.getMonth() + 1;
                        o.year = o.timestamp.getFullYear();
                        o.quarter = getQuarter(o.month);
                    });

                    updateProgress(50, 'ðŸ”„ Processing enrollments...');
                    
                    // Normalize enrollments
                    const enrollments = state.enrollmentsData.map(e => ({
                        email: normalizeEmail(e['User Email'] || e.user_email),
                        course: e['Course Name'] || e.course_name,
                        progress: parseFloat(e['User Progress (%)'] || e.progress || 0),
                        enrollmentDate: parseDate(e['Enrollment Date'] || e.enrollment_date),
                        classesWatched: e['Classes Watched'] || e.classes_watched
                    }));

                    // Create course map
                    const courseMap = {};
                    if (state.coursesData) {
                        state.coursesData.forEach(c => {
                            courseMap[c.course_name || c['Course Name']] = {
                                teacherId: c.teacher_id,
                                teacherName: c.teacher_name,
                                totalClasses: parseInt(c.total_classes) || 50
                            };
                        });
                    }

                    // Auto-generate course map if not provided
                    enrollments.forEach(e => {
                        if (!courseMap[e.course]) {
                            courseMap[e.course] = {
                                teacherId: `T${Object.keys(courseMap).length + 1}`,
                                teacherName: `Teacher ${Object.keys(courseMap).length + 1}`,
                                totalClasses: 50
                            };
                        }
                    });

                    updateProgress(70, 'ðŸ”„ Calculating eligibility...');
                    
                    // Build eligibility
                    const eligibility = [];
                    
                    enrollments.forEach(enroll => {
                        const courseInfo = courseMap[enroll.course] || {};
                        const totalClasses = courseInfo.totalClasses || 50;
                        const classesWatched = enroll.classesWatched || 
                            inferClassesWatched(enroll.progress, totalClasses);
                        
                        const meetsProgress = enroll.progress >= settings.minProgress;
                        const meetsClasses = classesWatched >= settings.minClasses;
                        const isEligible = meetsProgress && meetsClasses;
                        
                        const studentOrders = sales.filter(o => 
                            o.email === enroll.email &&
                            o.timestamp >= enroll.enrollmentDate
                        ).sort((a, b) => a.timestamp - b.timestamp);
                        
                        if (!isEligible || studentOrders.length === 0) return;
                        
                        // Track subscription IDs and first months
                        const subIds = {};
                        studentOrders.forEach(o => {
                            const subId = o.subscription_transaction_id;
                            if (subId && !subIds[subId]) {
                                subIds[subId] = o.timestamp;
                            }
                        });
                        
                        let eligibleCount = 0;
                        
                        studentOrders.forEach(order => {
                            if (eligibleCount >= 3) return;
                            
                            const subId = order.subscription_transaction_id;
                            const isFirstMonth = subId && subIds[subId] && 
                                order.timestamp.getTime() === subIds[subId].getTime();
                            
                            const baseAmount = settings.revenueBase === 'total' ? 
                                order.total : order.subtotal;
                            
                            const discountPct = computeDiscount(order.total, isFirstMonth);
                            const includeAdmission = isFirstMonth && 
                                discountPct > settings.discountThreshold;
                            
                            const admissionComponent = includeAdmission ? settings.admissionFee : 0;
                            const eligibleAmount = baseAmount + admissionComponent;
                            
                            eligibility.push({
                                email: enroll.email,
                                course: enroll.course,
                                teacherId: courseInfo.teacherId,
                                teacherName: courseInfo.teacherName,
                                orderId: order.id,
                                month: order.month,
                                year: order.year,
                                quarter: order.quarter,
                                isFirstMonth,
                                discountPct,
                                includeAdmission,
                                eligibleAmount
                            });
                            
                            eligibleCount++;
                        });
                    });

                    updateProgress(90, 'ðŸ”„ Calculating teacher payouts...');
                    
                    // Filter to selected quarter
                    const quarterEligible = eligibility.filter(e => 
                        e.quarter === settings.quarter && e.year === settings.year
                    );
                    
                    const quarterRevenue = _.sumBy(quarterEligible, 'eligibleAmount');
                    const teacherPool = quarterRevenue * settings.poolPercent;
                    
                    // Group by teacher
                    const teacherGroups = _.groupBy(quarterEligible, 'teacherId');
                    const teacherPayouts = Object.entries(teacherGroups).map(([teacherId, orders]) => {
                        const orderCount = orders.length;
                        const shareRatio = orderCount / quarterEligible.length;
                        const payout = teacherPool * shareRatio;
                        
                        return {
                            teacherId,
                            teacherName: orders[0].teacherName,
                            orderCount,
                            shareRatio,
                            payout
                        };
                    }).sort((a, b) => b.payout - a.payout);
                    
                    // Store results
                    state.results = {
                        settings,
                        quarterRevenue,
                        teacherPool,
                        totalOrders: quarterEligible.length,
                        teacherPayouts,
                        eligibility: quarterEligible,
                        allEligibility: eligibility
                    };
                    
                    updateProgress(100, 'âœ… Calculation complete!');
                    
                    setTimeout(() => {
                        displayResults();
                        document.getElementById('progressContainer').classList.add('hidden');
                    }, 500);
                    
                } catch (error) {
                    alert('Error calculating payouts: ' + error.message);
                    console.error(error);
                    document.getElementById('progressContainer').classList.add('hidden');
                }
            }, 100);
        }

        function displayResults() {
            const r = state.results;
            
            // Summary cards
            const summaryHTML = `
                <div class="card">
                    <h3>Quarter</h3>
                    <div class="value">Q${r.settings.quarter} ${r.settings.year}</div>
                </div>
                <div class="card">
                    <h3>Total Revenue</h3>
                    <div class="value">$${r.quarterRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="card">
                    <h3>Teacher Pool</h3>
                    <div class="value">$${r.teacherPool.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="card">
                    <h3>Total Orders</h3>
                    <div class="value">${r.totalOrders}</div>
                </div>
                <div class="card">
                    <h3>Teachers Paid</h3>
                    <div class="value">${r.teacherPayouts.length}</div>
                </div>
            `;
            document.getElementById('summaryCards').innerHTML = summaryHTML;
            
            // Teacher table
            const tableHTML = `
                <thead>
                    <tr>
                        <th>Teacher ID</th>
                        <th>Teacher Name</th>
                        <th>Eligible Orders</th>
                        <th>Share %</th>
                        <th>Payout Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${r.teacherPayouts.map(t => `
                        <tr>
                            <td>${t.teacherId}</td>
                            <td>${t.teacherName}</td>
                            <td>${t.orderCount}</td>
                            <td>${(t.shareRatio * 100).toFixed(1)}%</td>
                            <td><strong>$${t.payout.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            document.getElementById('resultsTable').innerHTML = tableHTML;
            
            // Show results
            document.getElementById('results').classList.add('show');
        }

        function exportCSV(type) {
            const r = state.results;
            let data, filename;
            
            if (type === 'teacher') {
                data = r.teacherPayouts.map(t => ({
                    teacher_id: t.teacherId,
                    teacher_name: t.teacherName,
                    quarter: r.settings.quarter,
                    year: r.settings.year,
                    eligible_orders: t.orderCount,
                    share_ratio: t.shareRatio.toFixed(4),
                    payout_amount: t.payout.toFixed(2),
                    total_quarter_revenue: r.quarterRevenue.toFixed(2),
                    teacher_pool_pct: (r.settings.poolPercent * 100).toFixed(0)
                }));
                filename = `teacher_summary_Q${r.settings.quarter}_${r.settings.year}.csv`;
            } else if (type === 'course') {
                const grouped = _.groupBy(r.eligibility, e => `${e.teacherId}_${e.course}_${e.month}`);
                data = Object.values(grouped).map(group => ({
                    teacher_id: group[0].teacherId,
                    teacher_name: group[0].teacherName,
                    course_name: group[0].course,
                    month: group[0].month,
                    year: group[0].year,
                    eligible_orders: group.length,
                    eligible_amount: _.sumBy(group, 'eligibleAmount').toFixed(2),
                    admission_included: group.filter(e => e.includeAdmission).length
                }));
                filename = `course_detail_Q${r.settings.quarter}_${r.settings.year}.csv`;
            } else {
                const grouped = _.groupBy(r.allEligibility, e => `${e.email}_${e.course}`);
                data = Object.values(grouped).map(group => ({
                    user_email: group[0].email,
                    course_name: group[0].course,
                    months_charged: group.map(e => e.month).join(','),
                    total_charged: group.length,
                    first_months: group.filter(e => e.isFirstMonth).length,
                    admission_included: group.filter(e => e.includeAdmission).length,
                    order_ids: group.map(e => e.orderId).join(',')
                }));
                filename = `student_audit_Q${r.settings.quarter}_${r.settings.year}.csv`;
            }
            
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportExcel() {
            const r = state.results;
            
            // Prepare sheets
            const teacherData = r.teacherPayouts.map(t => ({
                'Teacher ID': t.teacherId,
                'Teacher Name': t.teacherName,
                'Quarter': r.settings.quarter,
                'Year': r.settings.year,
                'Eligible Orders': t.orderCount,
                'Share Ratio': t.shareRatio.toFixed(4),
                'Payout Amount': t.payout.toFixed(2),
                'Total Quarter Revenue': r.quarterRevenue.toFixed(2),
                'Teacher Pool %': (r.settings.poolPercent * 100).toFixed(0)
            }));
            
            const courseGrouped = _.groupBy(r.eligibility, e => `${e.teacherId}_${e.course}_${e.month}`);
            const courseData = Object.values(courseGrouped).map(group => ({
                'Teacher ID': group[0].teacherId,
                'Teacher Name': group[0].teacherName,
                'Course Name': group[0].course,
                'Month': group[0].month,
                'Year': group[0].year,
                'Eligible Orders': group.length,
                'Eligible Amount': _.sumBy(group, 'eligibleAmount').toFixed(2),
                'Admission Included': group.filter(e => e.includeAdmission).length
            }));
            
            const studentGrouped = _.groupBy(r.allEligibility, e => `${e.email}_${e.course}`);
            const studentData = Object.values(studentGrouped).map(group => ({
                'User Email': group[0].email,
                'Course Name': group[0].course,
                'Months Charged': group.map(e => e.month).join(','),
                'Total Charged': group.length,
                'First Months': group.filter(e => e.isFirstMonth).length,
                'Admission Included': group.filter(e => e.includeAdmission).length,
                'Order IDs': group.map(e => e.orderId).join(',')
            }));
            
            const summaryData = [
                { 'Metric': 'Quarter', 'Value': `Q${r.settings.quarter}` },
                { 'Metric': 'Year', 'Value': r.settings.year },
                { 'Metric': 'Total Eligible Revenue', 'Value': `${r.quarterRevenue.toFixed(2)}` },
                { 'Metric': 'Teacher Pool', 'Value': `${r.teacherPool.toFixed(2)}` },
                { 'Metric': 'Total Eligible Orders', 'Value': r.totalOrders },
                { 'Metric': 'Number of Teachers', 'Value': r.teacherPayouts.length },
                { 'Metric': 'Generated At', 'Value': new Date().toLocaleString() }
            ];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            const ws1 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Summary');
            
            const ws2 = XLSX.utils.json_to_sheet(teacherData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Teacher Summary');
            
            const ws3 = XLSX.utils.json_to_sheet(courseData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Course Detail');
            
            const ws4 = XLSX.utils.json_to_sheet(studentData);
            XLSX.utils.book_append_sheet(wb, ws4, 'Student Audit');
            
            // Download
            XLSX.writeFile(wb, `exports_Q${r.settings.quarter}_${r.settings.year}.xlsx`);
        }
    </script>
</body>
</html>